<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Setup CORS for S3 and Cloudfront</title>
	
	<meta name="description" content="">
	<meta name="image" content="">
	
	<meta itemprop="name" content="Setup CORS for S3 and Cloudfront">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="">
	
	<meta name="og:title" content="Setup CORS for S3 and Cloudfront">
	<meta name="og:description" content="">
	
	<meta name="og:url" content="https://manhtai.github.io/posts/setup-cors-for-s3-and-cloudfront/">
	<meta name="og:site_name" content="Setup CORS for S3 and Cloudfront">
	<meta name="og:type" content="article">
	
	<meta name="article:tag" content="s3 cloudfront aws ">
	<link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
	
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-52114958-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
	
	<a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
	
	&nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
	
	
	
	<a href="https://manhtai.github.io//posts/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Setup CORS for S3 and Cloudfront <aside><a href="/tags/s3/">s3</a>&nbsp;&nbsp;&nbsp;<a href="/tags/cloudfront/">cloudfront</a>&nbsp;&nbsp;&nbsp;<a href="/tags/aws/">aws</a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <p>CORS problem arises in one of our apps because static files return from
CloudFront do not allow CORS. Specifically, they do not return following
header:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">Access-Control-Allow-Origin: *
</code></pre></div><p>The problem is, we&rsquo;ve setup CloudFront and S3 to support CORS as mentioned in
<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html">the docs</a>.</p>
<p>In S3 bucket rules, we have:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">[
    {
        <span style="color:#f92672">&#34;AllowedHeaders&#34;</span>: [
            <span style="color:#e6db74">&#34;Authorization&#34;</span>
        ],
        <span style="color:#f92672">&#34;AllowedMethods&#34;</span>: [
            <span style="color:#e6db74">&#34;GET&#34;</span>
        ],
        <span style="color:#f92672">&#34;AllowedOrigins&#34;</span>: [
            <span style="color:#e6db74">&#34;*&#34;</span>
        ],
        <span style="color:#f92672">&#34;ExposeHeaders&#34;</span>: [],
        <span style="color:#f92672">&#34;MaxAgeSeconds&#34;</span>: <span style="color:#ae81ff">20000</span>
    }
]
</code></pre></div><p>In CloudFront, we have:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">Cache and origin request settings: Use a cache policy and origin request policy
Cache Policy                     : Managed-CachingOptimized
Origin Request Policy            : Managed-CORS-S3Origin
</code></pre></div><p>All looks good, but our problem persists.</p>
<p>Continue following <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html">the docs</a>:</p>
<blockquote>
<p>How does Amazon S3 evaluate the CORS configuration on a bucket?</p>
</blockquote>
<blockquote>
<p>When Amazon S3 receives a preflight request from a browser, it evaluates the
CORS configuration for the bucket and uses the first CORSRule rule that matches
the incoming browser request to enable a cross-origin request. For a rule to
match, the following conditions must be met:</p>
</blockquote>
<blockquote>
<p>The request&rsquo;s Origin header must match an AllowedOrigin element.</p>
</blockquote>
<blockquote>
<p>The request method (for example, GET or PUT) or the Access-Control-Request-Method
header in case of a preflight OPTIONS request must be one of the AllowedMethod elements.</p>
</blockquote>
<blockquote>
<p>Every header listed in the request&rsquo;s Access-Control-Request-Headers header on the
preflight request must match an AllowedHeader element.</p>
</blockquote>
<p>We inspect the GET request that the browser makes to get the static files and
observe that the request header does not include <code>Origin</code> in the first request
send to CloudFront, and CloudFront does not send back
<code>Access-Control-Allow-Origin</code> header.</p>
<p>After the first request, CloudFront will cache the response header, and even
if the browser send the <code>Origin</code> request header next time, it still does not send back
<code>Access-Control-Allow-Origin</code> response header.</p>
<p>The solution is quite simple than we thought, we create a new cache policy with
<code>Origin</code> be one of the cache keys (the only different one from <code>Managed-CachingOptimized</code>
policy), then the problem goes away.</p>
<p>This works fine if the origin number is small as in our case.</p>
<p>There are two other ways:</p>
<ul>
<li>
<p>1, Use Lambda@Edge to set the necessary header.</p>
</li>
<li>
<p>2, Override origin header from CloudFront to a dummy one.</p>
</li>
</ul>
<p>2, feels a little bit hacky but it might be the best solution.</p>

</div>


  <p><small><em>Written on December 4, 2020. </em></small></p>






<footer>
	<p><aside>&copy; 2021</aside></a>
</footer>
</body>
</html>

