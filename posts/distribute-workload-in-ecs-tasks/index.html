<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Distribute workload between ECS tasks</title>
    
    <meta name="description" content="">
    <meta name="image" content="">
    
    <meta itemprop="name" content="Distribute workload between ECS tasks">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="">
    
    <meta name="og:title" content="Distribute workload between ECS tasks">
    <meta name="og:description" content="">
    
    <meta name="og:url" content="https://manhtai.github.io/posts/distribute-workload-in-ecs-tasks/">
    <meta name="og:site_name" content="Distribute workload between ECS tasks">
    <meta name="og:type" content="article">
    
    <meta name="article:tag" content="AWS ECS Go ">
    <link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/atom-one-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
    
    <a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
    
    &nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
    
    
    
    <a href="https://manhtai.github.io/posts/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Distribute workload between ECS tasks <aside><a href="/tags/aws/">AWS</a>&nbsp;&nbsp;&nbsp;<a href="/tags/ecs/">ECS</a>&nbsp;&nbsp;&nbsp;<a href="/tags/go/">Go</a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <p>If your ECS tasks are receiving traffic from a load balancer then the workload
will be equally distributed between them. How about when we are using ECS
tasks as a worker farm to handle long running jobs? And say, we want some
workers to work on some partitions of the data but not all of them? Then each
ECS task must know their identity and the number of tasks that belong to the
same service as well.</p>
<h2 id="1-get-task-arn">1. Get task ARN</h2>
<p>With <code>${ECS_CONTAINER_METADATA_URI_V4}/task</code> endpoint, we can get the task ARN
and metadata about its cluster and family.</p>
<p>After sending a GET request from our container, we got:</p>
<pre><code>{
    &quot;Cluster&quot;: &quot;default&quot;,
    &quot;TaskARN&quot;: &quot;arn:aws:ecs:us-west-2:111122223333:task/default/158d1c8083dd49d6b527399fd6414f5c&quot;,
    &quot;Family&quot;: &quot;curltest&quot;,
    ...
}
</code></pre><p>This request doesn&rsquo;t require any authentication at all, as long as we send it
from our ECS task.</p>
<h2 id="2-list-all-tasks-in-the-same-service">2. List all tasks in the same service</h2>
<p>With <code>Cluster</code> and <code>Family</code> of a task, we can list all running tasks in
a service using ECS API, in this example we will use Go SDK though:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#a6e22e">list</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ecsClient</span>.<span style="color:#a6e22e">ListTasks</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ecs</span>.<span style="color:#a6e22e">ListTasksInput</span>{
	<span style="color:#a6e22e">Cluster</span>:       <span style="color:#e6db74">&#34;default&#34;</span>,
	<span style="color:#a6e22e">Family</span>:        <span style="color:#e6db74">&#34;curltest&#34;</span>,
	<span style="color:#a6e22e">DesiredStatus</span>: <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">DesiredStatusRunning</span>,
})
</code></pre></div><p><code>list.TaskArns</code> contains all ARN of tasks in the service, including the task
making the request. This request does require authentication nevertheless.</p>
<h2 id="3-distribute-the-workload">3. Distribute the workload</h2>
<p>Now we know how many tasks we got, the problem becomes easy.</p>

</div>


  <p>
    <small>
      <em>
        Written on August 19, 2021.
        <a href="https://github.com/manhtai/manhtai.github.io/blob/develop/content/posts/distribute-workload-in-ecs-tasks.md">
          <svg height="16" viewBox="0 0 16 16" version="1.1" width="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
      </em>
    </small>
  </p>






<footer>
    <span class="copyleft">&copy;</span>2018 - 2021
</footer>
</body>
</html>

