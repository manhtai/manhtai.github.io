<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Django transactions</title>
	
	<meta name="description" content="">
	<meta name="image" content="">
	
	<meta itemprop="name" content="Django transactions">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="">
	
	<meta name="og:title" content="Django transactions">
	<meta name="og:description" content="">
	
	<meta name="og:url" content="https://manhtai.github.io/posts/django-transactions/">
	<meta name="og:site_name" content="Django transactions">
	<meta name="og:type" content="article">
	
	<meta name="article:tag" content="python django ">
	<link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
	
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-52114958-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
	
	<a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
	
	&nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
	
	
	
	<a href="https://manhtai.github.io/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Django transactions <aside><a href="/tags/python/">python</a></a>&nbsp;&nbsp;&nbsp;<a href="/tags/django/">django</a></a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <p>Django <a href="https://docs.djangoproject.com/en/dev/topics/db/transactions/">documentation</a> about transaction points out:</p>

<blockquote>
<p>Django uses transactions or savepoints automatically to guarantee the integrity
of ORM operations that require multiple queries, especially <code>delete()</code> and
<code>update()</code> queries.</p>
</blockquote>

<p>This means whenever we call <code>save()</code> or <code>create()</code>, it&rsquo;s already wrapped in
a transaction. And usually new data is not in the database yet when we try to
get that again somewhere after.</p>

<p>To make sure it&rsquo;s commited, we have to use <code>transaction.on_commit()</code>.</p>

<p>There are 2 popular cases I find that we must use <code>on_commit()</code> function.</p>

<p><em>The first one</em> is when we send task to a Celery queue. The error we usually made
here is to put that on a <code>post_save</code> signal and hope for the best. Remember that
<code>post_save</code> is in the same transaction with <code>save()</code>, so there is no guarantee
that new data will be in the database when Celery task get it from there.</p>

<p>We must use put the task to <code>on_commit()</code> function like this:</p>

<pre><code class="language-python">transaction.on_commit(lambda: celery_task_with_id(id))
</code></pre>

<p><em>The second case</em> is when we want to do something after all inline forms in
admin page is saved. But the thing we actually want is data is commited to
database. You already know how to do it, just like the case above.</p>

<p>The catch here is we can put <code>on_commit()</code> function in many places, as long as
it&rsquo;s in the transaction. I usually put that on <code>save_model()</code> or <code>save_related()</code>,
depend on what extra infomation I need for further processing.</p>

</div>







<footer>
	<p><aside>&copy;2020</aside></a>
</footer>
</body>
</html>

