<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Drain ECS instances before scaling down in EC2</title>
    
    <meta name="description" content="">
    <meta name="image" content="">
    
    <meta itemprop="name" content="Drain ECS instances before scaling down in EC2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="">
    
    <meta name="og:title" content="Drain ECS instances before scaling down in EC2">
    <meta name="og:description" content="">
    
    <meta name="og:url" content="https://manhtai.github.io/posts/drain-ecs-before-scaling-in-ec2/">
    <meta name="og:site_name" content="Drain ECS instances before scaling down in EC2">
    <meta name="og:type" content="article">
    
    <meta name="article:tag" content="AWS ECS Lambda ">
    <link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/atom-one-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
    
    <a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
    
    &nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
    
    
    
    <a href="https://manhtai.github.io/posts/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Drain ECS instances before scaling down in EC2 <aside><a href="/tags/aws/">AWS</a>&nbsp;&nbsp;&nbsp;<a href="/tags/ecs/">ECS</a>&nbsp;&nbsp;&nbsp;<a href="/tags/lambda/">Lambda</a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <h2 id="the-problem">The problem</h2>
<p>We have 2 independent auto scaling systems: EC2 auto scaling groups which
scales instances number &amp; ECS auto scaling which scales tasks number. This
setup may work fine when scaling up. Still, if new tasks need more instances
to start up, it must wait for them, but it&rsquo;s ok to wait a little.</p>
<p>But things soon become disaster when EC2 instances terminates <strong>before</strong>
ECS tasks draining out.</p>
<p>Actually, ECS instances will not auto drain to be ready for terminating
instances in EC2, so don&rsquo;t expect anything. We have to set that up manually.</p>
<h2 id="the-solution">The solution</h2>
<p>An AWS official <a href="https://aws.amazon.com/blogs/compute/how-to-automate-container-instance-draining-in-amazon-ecs/">blog</a> shows us how to do this, and it has a nice demo for
newly created EC2 &amp; ECS setup. But what if we just want to set up for our
running ECS instances? Here it is.</p>
<p>Firstly, make sure you know what <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/lifecycle-hooks.html">lifecycle hooks</a> are. Then follow these
steps:</p>
<ul>
<li>
<p>1, Create a lambda function using this <a href="https://gist.github.com/manhtai/66dfdae56ebce7b6270788018516a409">script</a>. It is my fork of AWS
sample <a href="https://github.com/aws-samples/ecs-cid-sample/blob/master/code/index.py">script</a>, but sucks less.</p>
</li>
<li>
<p>2, Set role for our lambda function to have these permissions:</p>
</li>
</ul>
<pre><code>- autoscaling:CompleteLifecycleAction
- logs:CreateLogGroup
- logs:CreateLogStream
- logs:PutLogEvents
- ec2:DescribeInstances
- ec2:DescribeInstanceAttribute
- ec2:DescribeInstanceStatus
- ec2:DescribeHosts
- ecs:ListContainerInstances
- ecs:SubmitContainerStateChange
- ecs:SubmitTaskStateChange
- ecs:DescribeContainerInstances
- ecs:UpdateContainerInstancesState
- ecs:ListTasks
- ecs:DescribeTasks
- sns:Publish
</code></pre><ul>
<li>
<p>3, Setup an SNS trigger for the function, choose a name for it.</p>
</li>
<li>
<p>4, Setup a service role so Auto Scaling Groups can push to SNS, using <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/lifecycle-hooks.html#sns-notifications">this
guide</a>. (This is quite interesting because you have to set up a role so
that a service will have some kind of permission).</p>
</li>
<li>
<p>5, Create a lifecycle hook by CLI, since the <strong>GUI is not fully supported
yet</strong>:</p>
</li>
</ul>
<pre><code>aws autoscaling put-lifecycle-hook
  --lifecycle-hook-name EcsWebScaleDown
  --auto-scaling-group-name ecs-web
  --lifecycle-transition autoscaling:EC2_INSTANCE_TERMINATING
  --heartbeat-timeout 900
  --notification-target-arn arn:aws:sns:ap-southeast-1:XXXXXXXXXXXX:EcsInstanceDrain
  --role-arn arn:aws:iam::XXXXXXXXXXXX:role/AutoScalingNotificationRole
</code></pre><p>It should be good now, as advertised :)</p>

</div>


  <p>
    <small>
      <em>
        Written on May 21, 2018.
        <a href="https://github.com/manhtai/manhtai.github.io/blob/develop/content/posts/drain-ecs-before-scaling-in-ec2.md">
          <svg height="16" viewBox="0 0 16 16" version="1.1" width="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
      </em>
    </small>
  </p>






<footer>
    <span class="copyleft">&copy;</span> 2021
</footer>
</body>
</html>

