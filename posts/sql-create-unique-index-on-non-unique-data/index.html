<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Create unique index on non-unique data</title>
    
    <meta name="description" content="">
    <meta name="image" content="">
    
    <meta itemprop="name" content="Create unique index on non-unique data">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="">
    
    <meta name="og:title" content="Create unique index on non-unique data">
    <meta name="og:description" content="">
    
    <meta name="og:url" content="https://manhtai.github.io/posts/sql-create-unique-index-on-non-unique-data/">
    <meta name="og:site_name" content="Create unique index on non-unique data">
    <meta name="og:type" content="article">
    
    <meta name="article:tag" content="sql Postgres ">
    <link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/atom-one-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
    
    <a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
    
    &nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
    
    
    
    <a href="https://manhtai.github.io/posts/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Create unique index on non-unique data <aside><a href="/tags/sql/">sql</a>&nbsp;&nbsp;&nbsp;<a href="/tags/postgres/">Postgres</a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <p>The title is a clickbait. You can&rsquo;t do that unless some data migrations were
done.</p>
<p>Let&rsquo;s say we have a font variant table with below schema:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> font_variants (
  family  VARCHAR(<span style="color:#ae81ff">255</span>)  <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  weight  INT           <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  style   VARCHAR(<span style="color:#ae81ff">255</span>)  <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
  user_id UUID          <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>
);
</code></pre></div><p>All is good until after a while, we realize that a variant is unique by
(<code>family</code>, <code>weight</code>, <code>style</code>) and we should enforce that on database level.
The problem is old data were filled up with not unique rows, when we try to
create an unique index like this, it will fail:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">INDEX</span> font_variants_family_weight_style_idx <span style="color:#66d9ef">ON</span>
font_variants(user_id, family, weight, style);
</code></pre></div><p>We can&rsquo;t make those rows unique unless we change the row data. Fortunately,
browsers are <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/font-weight#fallback_weights">handling</a> font-weight gracefully and we can do the migration
by changing the weight without huge impact on font display, even if you using
the weight on database for rendering font CSS directly.</p>
<p>Let&rsquo;s increase weight by the duplication number on each duplicated row:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">UPDATE</span> font_variants
<span style="color:#66d9ef">SET</span> weight <span style="color:#f92672">=</span> weight <span style="color:#f92672">+</span> rn <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">FROM</span> (<span style="color:#66d9ef">SELECT</span> id, row_number() OVER (PARTITION <span style="color:#66d9ef">BY</span> user_id, family, weight, style) rn
      <span style="color:#66d9ef">FROM</span> font_variants) fv
<span style="color:#66d9ef">WHERE</span> font_variants.id <span style="color:#f92672">=</span> fv.id;
</code></pre></div><p>We&rsquo;re good to do the unique index creation now.</p>

</div>


  <p>
    <small>
      <em>
        Written on October 21, 2022.
        <a href="https://github.com/manhtai/manhtai.github.io/blob/develop/content/posts/sql-create-unique-index-on-non-unique-data.md">
          <svg height="16" viewBox="0 0 16 16" version="1.1" width="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
      </em>
    </small>
  </p>






<footer>
    <span class="copyleft">&copy;</span> 2018 - 2023
</footer>
</body>
</html>

