<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Upgrade Postgres major version with near-zero-downtime</title>
    
    <meta name="description" content="">
    <meta name="image" content="">
    
    <meta itemprop="name" content="Upgrade Postgres major version with near-zero-downtime">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="">
    
    <meta name="og:title" content="Upgrade Postgres major version with near-zero-downtime">
    <meta name="og:description" content="">
    
    <meta name="og:url" content="https://manhtai.github.io/posts/upgrade-postgres-major-version-with-near-zero-downtime/">
    <meta name="og:site_name" content="Upgrade Postgres major version with near-zero-downtime">
    <meta name="og:type" content="article">
    
    <meta name="article:tag" content="Postgres AWS ">
    <link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/atom-one-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
    
    <a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
    
    &nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
    
    
    
    <a href="https://manhtai.github.io/posts/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Upgrade Postgres major version with near-zero-downtime <aside><a href="/tags/postgres/">Postgres</a>&nbsp;&nbsp;&nbsp;<a href="/tags/aws/">AWS</a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <p>Our system have a typical facing API and some workers which do jobs on the
background. All of them have read/write access to the Postgres instance. Our
instance is not very big, but when we try to upgrade using AWS console on the
clone, it takes more than 20 minutes and that&rsquo;s not acceptable.
Hence we were looking elsewhere, and find <a href="https://aws.amazon.com/blogs/database/achieving-minimum-downtime-for-major-version-upgrades-in-amazon-aurora-for-postgresql-using-aws-dms/">a solution</a> from AWS using DMS.
It worked out pretty well for us.</p>
<h2 id="step-by-step">Step by step</h2>
<ol>
<li>
<p>Clone a new instance from our current database, truncate all tables and
upgrade the new database to the latest version.</p>
</li>
<li>
<p>Full load and then CDC sync between the old database and the new one.
Monitor the latency as well as table statistics.</p>
</li>
<li>
<p>Stop all writing tasks (API &amp; workers) to old database.</p>
</li>
<li>
<p>Stop DMS job.</p>
</li>
<li>
<p>Switch database connection to the new one and restart all writing tasks.</p>
</li>
<li>
<p>Verify, then clean up old resources.</p>
</li>
</ol>
<h2 id="catches">Catches</h2>
<p>Current DMS engine (3.4.6) has some problems with some column types. But we
can resolve them quickly thanks to clear error logs:</p>
<ul>
<li><code>varchar</code> (without n), we have to convert it to <code>text</code></li>
<li><code>jsonb not null</code>, we have to make it nullable</li>
</ul>
<p>But in overall the upgrade process is smooth, we still got some downtime but
it&rsquo;s insignificant.</p>

</div>


  <p>
    <small>
      <em>
        Written on June 20, 2022.
        <a href="https://github.com/manhtai/manhtai.github.io/blob/develop/content/posts/upgrade-postgres-major-version-with-near-zero-downtime.md">
          <svg height="16" viewBox="0 0 16 16" version="1.1" width="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
      </em>
    </small>
  </p>






<footer>
    <span class="copyleft">&copy;</span> 2018 - 2022
</footer>
</body>
</html>

