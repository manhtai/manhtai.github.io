<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Wish our colleagues a happy birthday</title>
	
	<meta name="description" content="">
	<meta name="image" content="">
	
	<meta itemprop="name" content="Wish our colleagues a happy birthday">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="">
	
	<meta name="og:title" content="Wish our colleagues a happy birthday">
	<meta name="og:description" content="">
	
	<meta name="og:url" content="https://manhtai.github.io/posts/wish-our-colleagues-a-happy-birthday/">
	<meta name="og:site_name" content="Wish our colleagues a happy birthday">
	<meta name="og:type" content="article">
	
	<meta name="article:tag" content="bot metabase slack ">
	<link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
	
	
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-52114958-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
	
	<a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
	
	&nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
	
	
	
	<a href="https://manhtai.github.io/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Wish our colleagues a happy birthday <aside><a href="/tags/bot/">bot</a></a>&nbsp;&nbsp;&nbsp;<a href="/tags/metabase/">metabase</a></a>&nbsp;&nbsp;&nbsp;<a href="/tags/slack/">slack</a></a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <p>We build an intranet app using Django to help HR manage people at work. And
since we use Metabase for all our analysis tasks, we got the HR database to
query all the things about our colleagues (not the salary though, it&rsquo;s
accounting&rsquo;s matter).</p>

<p>I&rsquo;m not interested in my colleagues&rsquo; days of leave, but I wish they got a happy
birthday, so why don&rsquo;t we send out a wish, automatically?</p>

<p>I write a question in SQL, it&rsquo;s just as simple as list out all people who
have date and month equal to today&rsquo;s date and month. And use a <a href="/posts/metabase-alerts">bot</a> to
check the question everyday at 10am, then send out a wish if the question is
not empty.</p>

<p>The tricky part is we don&rsquo;t know firsthand what should be included in the
message, like our colleagues&rsquo; name, slack id, etc. So I have to evaluate them
at running time. The solution is to pass a string to alert message and then
convert it to string interpolation later. Like this:</p>

<pre><code class="language-js">// When creating alert
const originalMessage = &quot;Happy birthday to ${rows.join(&quot;, &quot;)}!&quot;;

// At running time
const rows = [&quot;some&quot;, &quot;data&quot;];
const theMessage = eval('`' + originalMessage + '`');
sendMessageToSlack(theMessage);
</code></pre>

<p>I know it&rsquo;s extremely risky to use <code>eval()</code> anywhere, so I use <a href="https://github.com/hacksparrow/safe-eval">safe-eval</a>
instead. Although at the moment it has a security <a href="https://github.com/hacksparrow/safe-eval/issues/5">bug</a>, it should be fine
for our internal use, at least for now.</p>

</div>




<footer>
	<p><aside>&copy;2018</aside></a>
</footer>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
	tex2jax: {
		inlineMath: [['$','$'], ['\\(','\\)']],
		displayMath: [['$$','$$'], ['\[','\]']],
		processEscapes: true,
		processEnvironments: true,
		skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
		TeX: { equationNumbers: { autoNumber: "AMS" },
		extensions: ["AMSmath.js", "AMSsymbols.js"] }
	}
});
</script>

<script type="text/x-mathjax-config">
	MathJax.Hub.Queue(function() {
	// Fix <code> tags after MathJax finishes running. This is a
	// hack to overcome a shortcoming of Markdown. Discussion at
	// https://github.com/mojombo/jekyll/issues/199
	var all = MathJax.Hub.getAllJax();
	for (var i = 0; i = all.length - 1; i += 1) {
		all[i].SourceElement().parentNode.className += ' has-jax';
	}
});
</script>

<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


</body>
</html>

