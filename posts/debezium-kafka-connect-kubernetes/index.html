<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Debezium Kafka Connect on Kubernetes</title>
	
	<meta name="description" content="">
	<meta name="image" content="">
	
	<meta itemprop="name" content="Debezium Kafka Connect on Kubernetes">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="">
	
	<meta name="og:title" content="Debezium Kafka Connect on Kubernetes">
	<meta name="og:description" content="">
	
	<meta name="og:url" content="https://manhtai.github.io/posts/debezium-kafka-connect-kubernetes/">
	<meta name="og:site_name" content="Debezium Kafka Connect on Kubernetes">
	<meta name="og:type" content="article">
	
	<meta name="article:tag" content="kafka-connect debezium kubernetes mysql-cdc ">
	<link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
	
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-52114958-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
	
	<a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
	
	&nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
	
	
	
	<a href="https://manhtai.github.io//posts/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Debezium Kafka Connect on Kubernetes <aside><a href="/tags/kafka-connect/">kafka-connect</a>&nbsp;&nbsp;&nbsp;<a href="/tags/debezium/">debezium</a>&nbsp;&nbsp;&nbsp;<a href="/tags/kubernetes/">kubernetes</a>&nbsp;&nbsp;&nbsp;<a href="/tags/mysql-cdc/">mysql-cdc</a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <p>In recent projects we had an usecase about streaming data from MySQL to
Kafka, and from that it can go wherever we want. We choose <a href="https://debezium.io/docs/connectors/mysql/">Debezium</a>
as a MySQL source connector for <a href="https://docs.confluent.io/current/connect/index.html">Kafka Connect</a>.</p>
<p>From Debezium website, we could easily find out what it does:</p>
<blockquote>
<p>Debezium&rsquo;s MySQL Connector can monitor and record all of the row-level
changes in the databases on a MySQL server or HA MySQL cluster. The
first time it connects to a MySQL server/cluster, it reads a consistent
snapshot of all of the databases. When that snapshot is complete, the
connector continuously reads the changes that were committed to MySQL
and generates corresponding insert, update and delete events. All of
the events for each table are recorded in a separate Kafka topic, where
they can be easily consumed by applications and services.</p>
</blockquote>
<p>Now to deploy Debezium connector to Kubernetes, there are 3 things we need to
keep in mind:</p>
<ul>
<li>
<p>1, Kafka Connect container must join your Kafka cluster to do the work.</p>
</li>
<li>
<p>2, We can pre-build Debezium connector in Kafka Connect image (or vice
versa), but we have to manually create new Kafka Connect source using REST
API.</p>
</li>
<li>
<p>3, We can do the 2nd thing automatically when deploying to K8s.</p>
</li>
</ul>
<p>Let&rsquo;t get started!</p>
<p>This is the Dockerfile for Kafka Connect with Debezium MySQL connector:</p>
<pre><code>FROM debezium/connect-base:0.9

ENV DEBEZIUM_VERSION=&quot;0.9.5.Final&quot; \
    MAVEN_REPO_CORE=&quot;https://repo1.maven.org/maven2&quot; \
    MAVEN_DEP_DESTINATION=$KAFKA_CONNECT_PLUGINS_DIR \
    MYSQL_MD5=720b1396358fbdc59bce953f47d3c53f

RUN docker-maven-download debezium mysql &quot;$DEBEZIUM_VERSION&quot; &quot;$MYSQL_MD5&quot;
</code></pre><p>If you want to use connector with other databases such as MongoDB, Postgresql,
Sqlserver, Oracle,&hellip; find the Dockerfile in <a href="https://github.com/debezium/docker-images/blob/master/connect/0.9/Dockerfile">Debezium docker images repo</a>.</p>
<p>Now a sample MySQL source configuration file:</p>
<pre><code># File: mysql-source.json
{
  &quot;name&quot;: &quot;inventory-connector&quot;,
  &quot;config&quot;: {
    &quot;connector.class&quot;: &quot;io.debezium.connector.mysql.MySqlConnector&quot;,
    &quot;database.hostname&quot;: &quot;192.168.99.100&quot;,
    &quot;database.port&quot;: &quot;3306&quot;,
    &quot;database.user&quot;: &quot;debezium&quot;,
    &quot;database.password&quot;: &quot;dbz&quot;,
    &quot;database.server.id&quot;: &quot;184054&quot;,
    &quot;database.server.name&quot;: &quot;fullfillment&quot;,
    &quot;database.whitelist&quot;: &quot;inventory&quot;,
    &quot;database.history.kafka.bootstrap.servers&quot;: &quot;kafka:9092&quot;,
    &quot;database.history.kafka.topic&quot;: &quot;dbhistory.fullfillment&quot;,
    &quot;include.schema.changes&quot;: &quot;true&quot;
  }
}
</code></pre><p>To automatically create a new source after starting new K8s pod, we must add
a new init script to our docker image which will wait for our Kafka Connect
service go online before excecuting a <code>curl</code> request to create a new source:</p>
<pre><code># File: init.sh
echo &quot;Wait for kafka connect...&quot;
until $(curl --output /dev/null --silent --head --fail http://172.17.0.1:8083); do
    printf '.'
    sleep 5
done

echo &quot;Install connector...&quot;
curl -i -X POST -H &quot;Accept:application/json&quot; -H  &quot;Content-Type:application/json&quot; http://172.17.0.1:8083/connectors/ -d @/kafka/init/mysql-source.json
</code></pre><p>Here, <code>172.17.0.1</code> is default localhost IP address for Docker guest container,
<code>8083</code> is the listening port of Kafka Connect.</p>
<p>We create a new entry point file for our image to run the <code>init.sh</code> script in
the background and waiting for Kafka Connect to go online.</p>
<pre><code># File: entrypoint.sh
/kafka/init/init.sh &amp;
exec /docker-entrypoint.sh start
</code></pre><p><code>/docker-entrypoint.sh</code> is the default entrypoint of Debezium connect image.</p>
<p>Now all are good, we have the final Dockerfile</p>
<pre><code>FROM debezium/connect-base:0.9

ENV DEBEZIUM_VERSION=&quot;0.9.5.Final&quot; \
    MAVEN_REPO_CORE=&quot;https://repo1.maven.org/maven2&quot; \
    MAVEN_DEP_DESTINATION=$KAFKA_CONNECT_PLUGINS_DIR \
    MYSQL_MD5=720b1396358fbdc59bce953f47d3c53f

RUN docker-maven-download debezium mysql &quot;$DEBEZIUM_VERSION&quot; &quot;$MYSQL_MD5&quot;

# Init script to create mysql source after starting container
RUN mkdir -p /kafka/init
COPY init.sh /kafka/init/
COPY mysql-source.json /kafka/init/

ENTRYPOINT [&quot;/kafka/init/entrypoint.sh&quot;]
</code></pre><p>That&rsquo;s it. Write up your k8s config and deploy the Kafka Connect pod to your
cluster!</p>

</div>


  <p><small><em>Written on June 15, 2019. </em></small></p>



  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript">
 
var CurrentPage = 0;

function ParseLinkHeader(link) {
	var entries = link && link.split(",") || [];
	var links = {};
	for (var i in entries) {
		var entry = entries[i];
		var link = {};
		link.name = entry.match(/rel=\"([^\"]*)/)[1];
		link.url = entry.match(/<([^>]*)/)[1];
		link.page = entry.match(/page=(\d+).*$/)[1];
		links[link.name] = link;
	}
	return links;
}

function DoGithubComments(comment_id, page_id) {
	var repo_name = "manhtai/manhtai.github.io";

	if (page_id === undefined)
		page_id = 1;

	var api_url = "https://api.github.com/repos/" + repo_name;
	var api_issue_url = api_url + "/issues/" + comment_id;
	var api_comments_url = api_url + "/issues/" + comment_id + "/comments" + "?page=" + page_id;

	var url = "https://github.com/" + repo_name + "/issues/" + comment_id;

	$(document).ready(function () {
		$.getJSON(api_issue_url, function(data) {
			NbComments = data.comments;
		});

		$.ajax(api_comments_url, {
			headers: {Accept: "application/vnd.github.v3.html+json"},
			dataType: "json",
			success: function(comments, textStatus, jqXHR) {

				
				if (page_id == 1)
					$("#gh-comments-list").append("<a href='" + url + "#new_comment_field' rel='nofollow' target='_blank' class='button'>Post new comment</a>");

				
				$.each(comments, function(i, comment) {
					var date = new Date(comment.created_at);
					var t = "<div id='gh-comment'>";
					
					t += "<b><a href='" + comment.user.html_url + "'>" + comment.user.login + "</a></b>";
					t += " posted at ";
					t += "<em>" + date.toUTCString() + "</em>";
					t += "<hr>";
					t += comment.body_html;
					t += "</div>";
					$("#gh-comments-list").append(t);
				});

				
				var links = ParseLinkHeader(jqXHR.getResponseHeader("Link"));
				if ("next" in links) {
					$("#gh-load-comments").attr("onclick", "DoGithubComments(" + comment_id + "," + (page_id + 1) + ");");
					$("#gh-load-comments").show();
				} else {
					$("#gh-load-comments").hide();
				}
			},
			error: function() {
				$("#gh-comments-list").append("<a href='" + url + "' rel='nofollow' target='_blank'class='button'>View all comments</a>");
			}
		});
    });
}

DoGithubComments( 3 );
</script>

<div id="gh-comments">
	<br/><br/>
	<h4>COMMENTS</h4>
	<div id="gh-comments-list"></div>
	<a href="javascript:void(0)" id="gh-load-comments" class="btn" style="display:none">Load more comments</a>
</div>





<footer>
	<p><aside>&copy; 2019</aside></a>
</footer>
</body>
</html>

