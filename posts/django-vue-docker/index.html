<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Dockerize Django Vue web app</title>
	
	<meta name="description" content="">
	<meta name="image" content="">
	
	<meta itemprop="name" content="Dockerize Django Vue web app">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="">
	
	<meta name="og:title" content="Dockerize Django Vue web app">
	<meta name="og:description" content="">
	
	<meta name="og:url" content="https://manhtai.github.io/posts/django-vue-docker/">
	<meta name="og:site_name" content="Dockerize Django Vue web app">
	<meta name="og:type" content="article">
	
	<meta name="article:tag" content="django docker drone.io ">
	<link rel="stylesheet" type="text/css" href="https://manhtai.github.io/css/style.css">
	
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-52114958-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<header>
	
	<a href="https://manhtai.github.io/" style="float: left;color:#777;"><strong>Go slowly</strong></a>
	
	&nbsp;&nbsp;<a href="https://manhtai.github.io/about/" style="color:#777;"><strong>About</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/contact/" style="color:#777;"><strong>Contact</strong></a>&nbsp;&nbsp;<a href="https://manhtai.github.io/archives/" style="color:#777;"><strong>Archives</strong></a>
	
	
	
	<a href="https://manhtai.github.io/index.xml" style="color:#777;float: right;"><strong><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></strong></a>
</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
      el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
  <h1>Dockerize Django Vue web app <aside><a href="/tags/django/">django</a></a>&nbsp;&nbsp;&nbsp;<a href="/tags/docker/">docker</a></a>&nbsp;&nbsp;&nbsp;<a href="/tags/drone.io/">drone.io</a></a>&nbsp;&nbsp;&nbsp;</aside></h1>
  <p>Recently I&rsquo;ve fired up multiple Django projects for my company. Most of them
follow a typical setup with Nginx + Gunicorn + Supervisord in a big Ubuntu
virtual machine. I must say that the setup works quite well, but sometimes,
when having not much more work to do, I strike for better by trying to
dockerize them.</p>
<h2 id="1-dockerize-django-vue-app-with-nginx--gunicorn">1) Dockerize Django-Vue app with Nginx &amp; Gunicorn</h2>
<p>I want to start with an app that has Vue as frontend. This method works with
all frontend frameworks, it just happens that we use Vue. The Vue part has a
separate repo so backend and frontend developers can work simultaneously. But
to build the docker image in the easiest way I put them into one by using git
submodule.</p>
<p>To build frontend part, I use <code>node:8</code> image:</p>
<pre><code>FROM node:8 as frontend

RUN mkdir /code
WORKDIR /code
ADD ./frontend /code/
RUN npm install yarn &amp;&amp; yarn &amp;&amp; yarn run build
</code></pre><p>I use <code>python:3.7-slim-stretch</code> to build backend, install <code>nginx</code>,
<code>supervisord</code> to the same image. Note that Nginx and Supervisord
configuration must be customized to run inside a Docker container.
You can refer to <a href="https://github.com/tiangolo/uwsgi-nginx-docker/blob/master/python3.6-alpine3.7/Dockerfile">uwsgi-nginx-docker</a> repo for more insights.</p>
<p>In case you still wonder, I use Supervisord to run Gunicorn and Nginx.</p>
<pre><code>FROM python:3.7-slim-stretch

# Install wget, gnupg to get nginx
RUN apt-get update &amp;&amp; apt-get install -y wget gnupg

RUN echo &quot;deb http://nginx.org/packages/mainline/debian/ stretch nginx&quot; &gt;&gt; /etc/apt/sources.list
RUN wget https://nginx.org/keys/nginx_signing.key -O - | apt-key add - &amp;&amp; \
  apt-get update &amp;&amp; \
  apt-get install -y nginx supervisor &amp;&amp; \
  rm -rf /var/lib/apt/lists/*

# Remove wget, gnupg
RUN apt-get purge -y --auto-remove wget gnupg

# Add code folder
RUN mkdir /code
WORKDIR /code
ADD . /code/

# Nginx configuration
RUN echo &quot;daemon off;&quot; &gt;&gt; /etc/nginx/nginx.conf
RUN rm /etc/nginx/conf.d/default.conf
COPY deploy/nginx_docker.conf /etc/nginx/conf.d/nginx_docker.conf

# Supervisor configuration
COPY deploy/supervisor_docker.conf /etc/supervisor/conf.d/supervisor_docker.conf
</code></pre><p>I use <a href="https://pipenv.readthedocs.io/">pipenv</a> instead of requirements file to manage dependencies:</p>
<pre><code># Install python lib dep
RUN pip install pipenv
RUN pipenv install --system --deploy
</code></pre><p>After that, collect staticfiles and expose them:</p>
<pre><code># Set env to production
ENV DJANGO_SETTINGS_MODULE myapp.settings.production

# Collect static files
RUN (cd myapp; python manage.py collectstatic --noinput)

VOLUME [&quot;/code/myapp/public&quot;]
</code></pre><p>Then copy frontend code from frontend build image to our main image:</p>
<pre><code>COPY --from=frontend /code/dist/ /code/dist/
</code></pre><p>And lastly, expose port for running:</p>
<pre><code>EXPOSE 80 443

CMD [&quot;/usr/bin/supervisord&quot;]
</code></pre><p>That&rsquo;s it. We&rsquo;ve had a Dockerfile that contains all frontend, backend and
a web server ready to use.</p>
<p>The reality that we can&rsquo;t build our Docker images by hands takes us to a CD
tool, and which tool should it be?</p>
<h2 id="2-cd-pipeline-using-droneio">2) CD pipeline using Drone.io</h2>
<p>I&rsquo;ve had some experience in writting Jenkinsfile for CD pipeline. It works
most of the time when I already had a Jenkins server running. But it costs me
hours and hours trying to set up a working Jenkins server in AWS, and then
I just quit. Some googling around, I found <a href="https://drone.io">Drone.io</a>.</p>
<p>The setup is dead simple, just one <code>docker-compose.yml</code> file and you got
a https CD server ready in minutes. I just fall in love with it immediately.</p>
<p>My config file is this:</p>
<pre><code>version: '2'

services:
  drone-server:
    image: drone/drone:0.8

    ports:
      - 80:80
      - 443:443
      - 9000:9000
    volumes:
      - ${HOME}/drone-data:/var/lib/drone/
    restart: always
    environment:
      - DRONE_OPEN=true
      - DRONE_ORGS=myteam
      - DRONE_ADMIN=myusername
      - DRONE_HOST=${DRONE_HOST}
      - DRONE_BITBUCKET=true
      - DRONE_BITBUCKET_CLIENT=${DRONE_BITBUCKET_CLIENT}
      - DRONE_BITBUCKET_SECRET=${DRONE_BITBUCKET_SECRET}
      - DRONE_SECRET=${DRONE_SECRET}
      - DRONE_LETS_ENCRYPT=true

  drone-agent:
    image: drone/agent:0.8

    command: agent
    restart: always
    depends_on:
      - drone-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DRONE_SERVER=drone-server:9000
      - DRONE_SECRET=${DRONE_SECRET}
</code></pre><p>You don&rsquo;t need nginx or something like just, just <code>docker-compose up -d</code> and
it&rsquo;s set. I wish all web applications are just simple as that!</p>
<p>Now you must define a <code>.drone.yml</code> file in your web server project, and it is
dead simple, too.</p>
<p>Here is the script for building the Docker image and then push it to AWS ECR:</p>
<pre><code>clone:
  git:
    image: plugins/git
    recursive: true
    # Override here so you don't have to edit it in your repo
    submodule_override:
      frontend: https://bitbucket.org/myteam/myapp.git

pipeline:
  ecr:
    image: plugins/ecr
    repo: &lt;account-id&gt;.dkr.ecr.ap-southeast-1.amazonaws.com/myapp
    registry: &lt;account-id&gt;.dkr.ecr.ap-southeast-1.amazonaws.com
    secrets: [ ecr_access_key, ecr_secret_key ]
    region: ap-southeast-1

  slack:
    image: plugins/slack
    channel: drone
    secrets: [ slack_webhook ]
    when:
      status: [ success, failure ]
</code></pre><p>And now in our server, <code>docker-compose.yml</code> file is now very simple:</p>
<pre><code>version: '2'

services:
  myapp:
    image: &lt;account-id&gt;.dkr.ecr.ap-southeast-1.amazonaws.com/myapp:latest

    ports:
      - 80:80
      - 443:443
    restart: always
    environment:
      - DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE}
</code></pre><p>Note that to pull images from ECR, you may need an <a href="https://github.com/awslabs/amazon-ecr-credential-helper">ECR credential helper</a>.</p>
<h2 id="3-conclusion">3) Conclusion</h2>
<p>Now to start your server, you just need to run <code>docker-compose up -d</code> and it&rsquo;s
set! Our Django app is just like a typical Golang app: one Docker image and
nothing more.</p>
<p>I&rsquo;ve crossed out some things here so you can find out for yourself:</p>
<ul>
<li>
<p>- Add test step to Drone pipeline (if you had some!).</p>
</li>
<li>
<p>- Add deploy step to Drone pipeline so it can be complete.</p>
</li>
<li>
<p>- Use another container scheduling and management system like <a href="https://kubernetes.io/">Kubernetes</a>
instead of Docker compose.</p>
</li>
</ul>

</div>


  <p><small><em>Written on August 24, 2018. </em></small></p>






<footer>
	<p><aside>&copy;2020</aside></a>
</footer>
</body>
</html>

